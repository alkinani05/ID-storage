# ✅ Wathiqni Deployment Checklist

## Pre-Deployment Verification

Run the verification script to check for common issues:
```bash
./verify-deployment.sh
```

## Railway Deployment Steps

### 1. Database Setup
- [ ] Create PostgreSQL service in Railway
- [ ] Wait for database to be ready
- [ ] Copy `DATABASE_URL` from database service (Railway auto-generates this)

### 2. Backend Deployment
- [ ] Create new service from GitHub repo
- [ ] Set root directory to `/server`
- [ ] Configure environment variables:
  ```
  DATABASE_URL=<auto-generated-by-railway>
  JWT_SECRET=<generate-secure-random-string>
  PORT=3001
  CORS_ORIGIN=<will-add-after-frontend-deployed>
  ```
- [ ] Optional: Add `OPENAI_API_KEY` for advanced AI analysis
- [ ] Deploy and wait for build to complete
- [ ] Generate domain in Networking tab
- [ ] Test health endpoint: `curl https://your-backend.railway.app/health`
- [ ] Expected response: `{"status":"ok","timestamp":"..."}`

### 3. Frontend Deployment
- [ ] Create new service from same GitHub repo
- [ ] Set root directory to `/client`
- [ ] Configure environment variables:
  ```
  NEXT_PUBLIC_API_URL=https://your-backend-url.railway.app
  NEXT_PUBLIC_MAX_FILE_SIZE=10485760
  ```
- [ ] Deploy and wait for build to complete
- [ ] Generate domain in Networking tab

### 4. Update Backend CORS
- [ ] Go back to backend service
- [ ] Update `CORS_ORIGIN` variable:
  ```
  CORS_ORIGIN=https://your-frontend-url.railway.app
  ```
  Or for multiple origins:
  ```
  CORS_ORIGIN=https://frontend1.railway.app,https://frontend2.railway.app
  ```
- [ ] Redeploy backend service

### 5. Post-Deployment Testing
- [ ] Visit frontend URL
- [ ] Test user registration
- [ ] Test user login
- [ ] Test document upload
- [ ] Test OCR functionality
- [ ] Test document sharing
- [ ] Check browser console for errors
- [ ] Verify CORS is working (no CORS errors in console)

## Common Issues & Solutions

### ❌ 502 Bad Gateway
**Check:**
- Railway logs for backend service
- Database connection (DATABASE_URL set correctly)
- Prisma migrations ran successfully
- Health endpoint responds

**Fix:**
```bash
# Check logs in Railway dashboard
# Verify DATABASE_URL is set
# Ensure migrations completed: look for "npx prisma migrate deploy" in logs
```

### ❌ CORS Errors
**Check:**
- CORS_ORIGIN includes frontend URL
- Backend logs show correct allowed origins

**Fix:**
```bash
# Update CORS_ORIGIN in backend service
CORS_ORIGIN=https://your-frontend.railway.app
# Redeploy backend
```

### ❌ Frontend Can't Connect to Backend
**Check:**
- NEXT_PUBLIC_API_URL is set correctly
- Backend is running and accessible

**Fix:**
```bash
# Update NEXT_PUBLIC_API_URL in frontend service
NEXT_PUBLIC_API_URL=https://your-backend.railway.app
# IMPORTANT: Redeploy frontend (env vars require rebuild)
```

### ❌ OCR Fails
**Check:**
- Tesseract packages installed in Dockerfile
- Backend logs for Tesseract errors

**Fix:**
- Verify Dockerfile has:
  ```dockerfile
  RUN apk add --no-cache tesseract-ocr tesseract-ocr-data-ara tesseract-ocr-data-eng
  ```

### ❌ File Upload Fails
**Check:**
- Upload directory permissions
- File size limits
- Railway disk space

**Fix:**
- Verify MAX_FILE_SIZE environment variable
- Check Dockerfile creates uploads directory with correct permissions

## Environment Variables Reference

### Backend (Required)
- `DATABASE_URL` - PostgreSQL connection string (auto-generated by Railway)
- `JWT_SECRET` - Secret key for JWT tokens (generate random string)
- `PORT` - Server port (default: 3001)
- `CORS_ORIGIN` - Allowed frontend URLs (comma-separated)

### Backend (Optional)
- `OPENAI_API_KEY` - OpenAI API key for advanced document analysis
- `MAX_FILE_SIZE` - Maximum upload size in bytes (default: 10485760 = 10MB)
- `UPLOAD_DIR` - Upload directory path (default: ./uploads)

### Frontend (Required)
- `NEXT_PUBLIC_API_URL` - Backend API URL
- `NEXT_PUBLIC_MAX_FILE_SIZE` - Maximum upload size (should match backend)

## Deployment URLs Template

After deployment, update this section with your actual URLs:

```
Frontend: https://_____________________.railway.app
Backend:  https://_____________________.railway.app
Database: (internal only, not publicly accessible)
```

## Rollback Plan

If deployment fails:
1. Check Railway logs for specific errors
2. Revert to previous deployment in Railway dashboard
3. Fix issues locally and test with `./verify-deployment.sh`
4. Redeploy after verification

## Success Criteria

✅ All services show "Active" status in Railway
✅ Health endpoint returns 200 OK
✅ Frontend loads without errors
✅ User can register and login
✅ Document upload works
✅ OCR extracts text from documents
✅ No CORS errors in browser console
✅ Document sharing generates valid links

## Support

If you encounter issues not covered here:
1. Check Railway logs (Deployments → Latest → View Logs)
2. Review RAILWAY_DEPLOY.md for detailed troubleshooting
3. Run `./verify-deployment.sh` to check for configuration issues
